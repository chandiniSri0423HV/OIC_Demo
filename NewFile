pipeline {
    agent any

    stages {
        stage('Import Integration') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'DEV_CredID', usernameVariable: 'USR', passwordVariable: 'PSW')]) {
                    script {
                        def serviceURL = ""
                        def testInstance = ""

                        if (params.InstanceURL.toString() == "DEV") {
                            echo "Using DEV environment"
                            serviceURL = env.DEV_URL
                            testInstance = env.test_Integration_Instance
                        }

                        echo "Service URL: ${serviceURL}"
                        echo "Import Method: ${params.Import_Method}"

                        def selectedOption = "${params.Import_Method}".trim()
                        if (selectedOption == 'New') {
                            echo 'Adding new integration'
                            def integURL = "${serviceURL}/ic/api/integration/v1/integrations/archive?integrationInstance=${testInstance}"
                            echo "Integration URL: ${integURL}"
                            def deployIntegCmd = "curl --location \"${integURL}\" --user ${USR}:${PSW} --form \"file=@\\\"${params.IARFileName}\\\"\""
                            bat(deployIntegCmd)
                        }
                    }
                }
            }
        }
    }
}
