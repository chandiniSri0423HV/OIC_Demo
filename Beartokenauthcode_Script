pipeline {
    agent any

    environment {
        OIC_HOST       = 'https://design.integration.us-ashburn-1.ocp.oraclecloud.com'
        TOKEN_URL      = 'https://idcs-b0bf5647dbe34af4914cf420cba0294c.identity.oraclecloud.com/oauth2/v1/token'
        INSTANCE_PARAM = '?integrationInstance=testinstance-xyz'
        ARCHIVE_FILE   = 'ITEM_INTEGRATION_01.00.0000.iar'
    }

    stages {
        stage('Get Token & Upload Integration') {
            steps {
                withCredentials([string(credentialsId: 'Basic_Auth_Encoded', variable: 'ENCODED_AUTH')]) {
                    bat """
                        @echo off
                        echo Generating Bearer token...

                        curl -s -X POST "%TOKEN_URL%" ^
                          -H "Authorization: Basic %ENCODED_AUTH%" ^
                          -H "Content-Type: application/x-www-form-urlencoded" ^
                          --data-urlencode "grant_type=client_credentials" ^
                          --data-urlencode "scope=%OIC_HOST%:443urn:opc:resource:consumer::all" ^
                          --insecure > token.json

                        for /f %%i in ('powershell -Command "(Get-Content token.json | Out-String | ConvertFrom-Json).access_token"') do set TOKEN=%%i

                        echo Extracted Bearer Token: %TOKEN%

                        echo Importing Integration Archive...
                        curl --location --request POST "%OIC_HOST%/ic/api/integration/v1/integrations/archive%INSTANCE_PARAM%" ^
                          --header "Authorization: Bearer %TOKEN%" ^
                          --header "Accept: application/json" ^
                          --form "file=@%ARCHIVE_FILE%" ^
                          --form "type=application/octet-stream" ^
                          --insecure
                    """
                }
            }
        }
    }
}
