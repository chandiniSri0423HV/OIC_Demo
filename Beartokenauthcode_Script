pipeline {
    agent any

    environment {
        OIC_HOST       = 'https://design.integration.us-ashburn-1.ocp.oraclecloud.com'
        TOKEN_URL      = 'https://idcs-.../oauth2/v1/token'
        INSTANCE_PARAM = '?integrationInstance=testinstance-xyz'
        ARCHIVE_FILE   = 'ITEM_INTEGRATION_01.00.0000.iar'
    }

    stages {
        stage('Get Token & Upload Integration') {
            steps {
                withCredentials([string(credentialsId: 'Basic_Auth_Encoded', variable: 'ENCODED_AUTH')]) {
                    script {
                        def tokenResp = httpRequest(
                            httpMode: 'POST',
                            url: "${env.TOKEN_URL}",
                            customHeaders: [[name: 'Authorization', value: "Basic ${ENCODED_AUTH}"],
                                            [name: 'Content-Type', value: 'application/x-www-form-urlencoded']],
                            requestBody: "grant_type=client_credentials&scope=${env.OIC_HOST}:443urn:opc:resource:consumer::all'],
                            validResponseCodes: '200'
                        )
                        def access_token = new groovy.json.JsonSlurperClassic().parseText(tokenResp.content).access_token

                        echo "Extracted Bearer Token: ${access_token}"

                        bat """
                            curl --location --request POST "${OIC_HOST}/ic/api/integration/v1/integrations/archive${INSTANCE_PARAM}" ^
                            --header "Authorization: Bearer ${access_token}" ^
                            --header "Accept: application/json" ^
                            --form "file=@${ARCHIVE_FILE}" ^
                            --form "type=application/octet-stream" ^
                            --insecure
                        """
                    }
                }
            }
        }
    }
}
